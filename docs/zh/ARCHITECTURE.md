# TokenMeter 架构文档

本文档提供 TokenMeter 项目的可视化架构图，帮助快速理解系统结构和数据流。

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           TokenMeter 整体架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        macOS 系统托盘                                │   │
│  │  ┌──────────────┐                                                   │   │
│  │  │ Tray Icon    │ ← 显示实时用量 ($34.02 39.3M)                     │   │
│  │  │ + Menu       │ ← Today/Last 30 Days/模型明细                     │   │
│  │  └──────────────┘                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Tauri 2 Runtime                              │   │
│  │  ┌─────────────────────────┐     ┌─────────────────────────────┐   │   │
│  │  │     React Frontend      │     │       Rust Backend          │   │   │
│  │  │  ┌───────────────────┐  │     │  ┌───────────────────────┐  │   │   │
│  │  │  │ Dashboard         │  │     │  │ commands/             │  │   │   │
│  │  │  │ ProviderEditor    │◄─┼─────┼─►│   usage.rs            │  │   │   │
│  │  │  │ Settings          │  │ IPC │  │   providers.rs        │  │   │   │
│  │  │  └───────────────────┘  │     │  └───────────────────────┘  │   │   │
│  │  │           │             │     │            │                │   │   │
│  │  │           ▼             │     │            ▼                │   │   │
│  │  │  ┌───────────────────┐  │     │  ┌───────────────────────┐  │   │   │
│  │  │  │ TanStack Query    │  │     │  │ services/             │  │   │   │
│  │  │  │ (缓存 + 轮询)     │  │     │  │   ccusage.rs          │  │   │   │
│  │  │  └───────────────────┘  │     │  │   pricing.rs          │  │   │   │
│  │  │                         │     │  │   script_runner.rs    │  │   │   │
│  │  └─────────────────────────┘     │  └───────────────────────┘  │   │   │
│  │                                  └─────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          外部依赖                                    │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │   │
│  │  │ ccusage CLI  │  │ models.dev   │  │ curl/wget/http/httpie    │  │   │
│  │  │ (用量数据)   │  │ (价格 API)   │  │ (Provider fetch)         │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据流详解                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ══════════════════════════════════════════════════════════════════════    │
│  ║                    1. ccusage 用量数据流                            ║    │
│  ══════════════════════════════════════════════════════════════════════    │
│                                                                             │
│  ┌──────────────┐    shell -l -c     ┌──────────────┐                      │
│  │ ccusage CLI  │◄───────────────────│ ccusage.rs   │                      │
│  │ (npm 全局)   │                    │              │                      │
│  └──────┬───────┘                    └──────┬───────┘                      │
│         │                                   │                              │
│         │ JSON (daily + totals)             │ 解析 + 转换                  │
│         ▼                                   ▼                              │
│  ┌──────────────────────────────────────────────────────────────────┐     │
│  │  CcusageResponse { daily: [...], totals: {...} }                 │     │
│  └──────────────────────────────────────────────────────────────────┘     │
│         │                                                                  │
│         │ cost == 0 ? ──► pricing.rs ──► models.dev API                   │
│         ▼                                                                  │
│  ┌──────────────────────────────────────────────────────────────────┐     │
│  │  UsageSummary { today, thisMonth, dailyUsage, modelBreakdown }   │     │
│  └──────────────────────────────────────────────────────────────────┘     │
│         │                                                                  │
│         ├──► AppState.usage (Mutex 缓存)                                  │
│         └──► tray.rs (更新菜单栏标题 + 菜单)                              │
│                                                                            │
│  ══════════════════════════════════════════════════════════════════════    │
│  ║                 2. 自定义 Provider 数据流                           ║    │
│  ══════════════════════════════════════════════════════════════════════    │
│                                                                             │
│  ApiProvider { fetchScript, transformScript, env }                         │
│         │                                                                  │
│         │ 安全验证 (仅允许 curl/wget/http/httpie)                         │
│         ▼                                                                  │
│  ┌──────────────┐    Command::new()   ┌──────────────┐                    │
│  │ shell_utils  │───────────────────►│ 外部 HTTP    │                    │
│  │ parse_command│    env_clear()      │ 客户端       │                    │
│  └──────────────┘                     └──────┬───────┘                    │
│                                              │ JSON 响应                   │
│                                              ▼                             │
│  ┌──────────────────────────────────────────────────────────────────┐     │
│  │  script_runner.rs (boa_engine JS 沙箱, 5秒超时, 10KB限制)        │     │
│  └──────────────────────────────────────────────────────────────────┘     │
│         │                                                                  │
│         ▼                                                                  │
│  ProviderUsageResult { cost?, tokens?, used?, total? }                    │
│                                                                            │
│  ══════════════════════════════════════════════════════════════════════    │
│  ║                    3. 前后端通信                                    ║    │
│  ══════════════════════════════════════════════════════════════════════    │
│                                                                             │
│   Frontend (React)                         Backend (Rust)                  │
│                                                                             │
│   api.ts ──────── invoke() ──────────────► #[tauri::command]              │
│          ◄─────── JSON Response ──────────                                 │
│                                                                             │
│   App.tsx ◄────── listen('navigate') ────── lib.rs emit()                 │
│   Dashboard ◄──── listen('usage-preloaded') lib.rs emit()                 │
│   App/Tray ◄───── listen('config-updated') usage.rs emit()                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 后端模块依赖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          后端模块依赖关系                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  main.rs ──► lib.rs                                                        │
│                 │                                                           │
│                 ├── 注册 Tauri 命令                                        │
│                 ├── 初始化 AppState                                        │
│                 ├── 设置系统托盘                                           │
│                 └── 启动后台预加载任务                                     │
│                 │                                                           │
│      ┌──────────┼──────────┬──────────────┬──────────────┐                 │
│      │          │          │              │              │                 │
│      ▼          ▼          ▼              ▼              ▼                 │
│  tray.rs   commands/   services/     state.rs      config.rs              │
│      │     usage.rs    ccusage.rs        │          types.rs              │
│      │     providers   pricing.rs        │          error.rs              │
│      │         .rs     script_runner     │                                 │
│      │                 shell_utils       │                                 │
│      │                      │            │                                 │
│      └──────────────────────┴────────────┘                                 │
│                             │                                              │
│                             ▼                                              │
│                    共享类型模块                                            │
│                    (config/types/error)                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 前端模块结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          前端模块结构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  main.tsx ──► QueryClientProvider                                          │
│                    │                                                        │
│                    ▼                                                        │
│               App.tsx                                                       │
│                    │                                                        │
│       ┌────────────┼────────────┐                                          │
│       │            │            │                                          │
│       ▼            ▼            ▼                                          │
│  Dashboard   ProviderEditor  Settings                                      │
│       │            │            │                                          │
│       └────────────┴────────────┘                                          │
│                    │                                                        │
│                    ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         hooks/                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │ useUsageData │  │ useProviders │  │ useTheme     │              │   │
│  │  │ useConfig    │  │ useSave...   │  │ useLanguage  │              │   │
│  │  │ useRefresh   │  │ useDelete... │  │ useConfigEvents            │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────────────┘              │   │
│  └─────────┼─────────────────┼──────────────────────────────────────────┘   │
│            │                 │                                              │
│            ▼                 ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        lib/api.ts                                    │   │
│  │  getUsageSummary() │ getProviders()  │ getConfig()                  │   │
│  │  refreshUsage()    │ saveProvider()  │ saveConfig()                 │   │
│  │                    │ deleteProvider()│                              │   │
│  │                    │ testProvider()  │                              │   │
│  └────────────────────────────┬────────────────────────────────────────┘   │
│                               │                                             │
│                               │ invoke()                                    │
│                               ▼                                             │
│                    @tauri-apps/api/core                                     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      components/ui/                                  │   │
│  │  button │ card │ input │ label │ separator │ switch │ tabs │ textarea│   │
│  │                       (shadcn/ui)                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          i18n/                                       │   │
│  │  index.ts (i18next 初始化) │ locales/{en,zh}/*.json (翻译文件)      │   │
│  │                    (i18next + react-i18next)                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       types/index.ts                                 │   │
│  │  UsageSummary │ ApiProvider │ AppConfig │ MenuBarConfig │ ...       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 配置存储结构

```
~/.tokenmeter/
├── config.json              # 应用配置
│   ├── refreshInterval      # 刷新间隔 (秒)
│   ├── launchAtLogin        # 开机启动
│   ├── language             # 语言偏好 ("en"/"zh", 可选，默认跟随系统)
│   └── menuBar              # 菜单栏配置
│       ├── format           # 显示格式 (${cost} ${tokens})
│       ├── fixedBudget      # 每日预算
│       └── showColorCoding  # 颜色编码
│
└── providers/               # 自定义 Provider 配置
    └── {id}.json
        ├── id               # Provider ID
        ├── name             # 显示名称
        ├── enabled          # 是否启用
        ├── fetchScript      # 数据抓取脚本
        ├── transformScript  # JS 转换脚本
        └── env              # 环境变量
```

主题偏好存储在 `localStorage`（key: `tokenmeter-theme`），多窗口通过 `storage` 事件同步。
